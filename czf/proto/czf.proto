syntax = "proto3";

message Node {
  string hostname = 1;
  string identity = 2;
}

message Model {
  string name = 1;
  int32 version = 2;
  repeated bytes blobs = 3;
}

message State {
  message Evaluation {
    bytes latent = 1;
    float value = 2;
    repeated float policy = 3;
  }
  message Transition {
    int32 action = 1;
    repeated float rewards = 2;
  }
  string serialize = 1;
  int32 current_player = 2;
  repeated int32 legal_actions = 3;
  repeated float observation_tensor = 4;
  Evaluation evaluation = 5;
  Transition transition = 6;
}

message Trajectory {
  repeated State states = 1;
  // returns for each player
  repeated float returns = 2;
}

message Heartbeat {}

message Job {
  enum Operation {
    UNKNOWN = 0;
    ALPHAZERO_SEARCH = 1;
    ALPHAZERO_OPTIMIZE = 2;
    MUZERO_PREPROCESS = 3;
    MUZERO_SEARCH = 4;
    MUZERO_OPTIMIZE = 5;
  }
  message Payload {
    State state = 1;
    Trajectory trajectory = 2;
    int32 env_index = 3;
  }
  string id = 1;
  Node initiator = 2;
  Model model = 3;
  repeated Operation procedure = 4;
  int32 step = 5;
  repeated Node workers = 6;
  Payload payload = 7;
}

message JobRequest {
  Job.Operation operation = 1;
  int32 capacity = 2;
}

message JobResponse { repeated Job jobs = 1; }

message Packet {
  oneof payload {
    Heartbeat heartbeat = 1;
    Model model_request = 2;
    Model model_response = 3;
    Model model = 4;
    JobRequest job_request = 5;
    JobResponse job_response = 6;
    Job job = 7;
  }
}